---
- name: Node Executor Playbook
  hosts: all
  become: yes
  vars:
    svc: "{{ service_name }}"
    version: "{{ deploy_version }}"
    package_url: "{{ package_url }}"
    package_md5sum: "{{ package_md5sum}}"
    release_dir: "/opt/releases/{{ svc }}/{{ version }}"
    systemd_unit: "/etc/systemd/system/{{ svc }}@{{ version }}.service"
    prev_version: "{{ prev_version }}"

  tasks:

    # ---------------------------
    # ✅ 部署新版本
    # ---------------------------
    - name: Ensure release directory exists
      file:
        path: "{{ release_dir }}"
        state: directory
        mode: '0755'

    - name: Download package
      get_url:
        url: "{{ package_url }}"
        dest: "{{ release_dir }}/{{ svc }}.tar.gz"
        mode: '0644'

    - name: Verify md5 checksum
      shell: "md5sum {{ release_dir }}/{{ svc }}.tar.gz | awk '{print $1}'"
      register: md5sum_out 
      changed_when: false

    - name: Fail if checksum mismatch
      fail:
        msg: "md5 checksum mismatch for {{ svc }} version {{ version }}"
      when: md5sum_out.stdout != package_md5sum

    - name: Extract package
      unarchive:
        src: "{{ release_dir }}/{{ svc }}.tar.gz"
        dest: "{{ release_dir }}"
        remote_src: yes
        extra_opts:
          - --strip-components=1

    - name: Render systemd unit
      template:
        src: "templates/{{ svc }}@.service.j2"
        dest: "{{ systemd_unit }}"
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Stop previous version if exists
      systemd:
        name: "{{ svc }}@{{ prev_version }}"
        state: stopped
      when: prev_version is defined and prev_version | length > 0
      ignore_errors: yes

    - name: Start new version
      systemd:
        name: "{{ svc }}@{{ version }}"
        state: started
        enabled: yes

    # ---------------------------
    # 🔁 Rollback section
    # ---------------------------
    - block:
        - name: Stop current version before rollback
          systemd:
            name: "{{ svc }}@{{ version }}"
            state: stopped
          ignore_errors: yes

        - name: Start previous version
          systemd:
            name: "{{ svc }}@{{ prev_version }}"
            state: started
            enabled: yes
      when: rollback | default(false)
